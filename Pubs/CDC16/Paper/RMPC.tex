\section{Robust MPC for the feedback linearized system}

Following \cite{RichardsH05_RMPC}, \cite{PantAMNDM15_Anytime}, we formulate a Robust MPC (RMPC) controller of \eqref{eq:discrete linear problem} via \emph{constraint restriction}.
We outline the idea before providing the technical details.
The key idea is to move the effects of estimation error $\tilde{e}_k$ and  process noise $w_k$ (the `disturbances') to the constraints, and work with the nominal  (i.e., disturbance-free) dynamics: $\nz_{k+1} = A\nz_{k}+Bv_k$, $\nz_{0} = z_0$.
Because we would be optimizing over disturbance-free states, we must account for the noise in the constraints. 
Specifically, rather than require the next (nominal) state $\nz_{k+1}$ to be in $Z$, we require it to be in the shrunk set $Z \ominus \What_{k+1|k} \ominus \tE_{k+1|k}$: by definition of Pontryagin difference, this implies that whatever the actual value of the noise $\hw_{k+1} \in \What_{k+1|k}$ and of the estimation error $\tilde{e}_{k+1} \in \tE_{k+1|k}$, the actual state $z_{k+1}$ will be in $Z$. 
This is repeated over the entire MPC prediction horizon $j=1,\ldots,N$, with further shrinking at every step.
For further steps ($j>1$), the process noise $\What_{k+j|k}$ is propagated through the dynamics, so the shrinking term $\What$ is shaped by a stabilizing feedback controller $x \mapsto Kx$.
At the final step ($j=N$), a terminal constraint is derived using the worst case estimation error set $\tE_{max}$ and a convex global inner approximation for the input constraints, $V_{inner-global}$. 
Details of this construction follow below.

Through this successive constraint tightening we ensure robust safety and feasibility of the feedback linearized system (and hence of the non-linear system). 
Since we use just the nominal dynamics, and show that the tightened constraints are linear in the state and inputs, we still solve a Quadratic Program (QP) for the MPC optimization.
The difficulty of applying RMPC in our setting is that the amounts by which the various sets are shrunk varies with time and is (nonlinear) state-dependent, and involves set computations with the non-convexity preserving mapping $T$.
One of our contributions in this paper is to establish recursive feasibility of MPC with time-varying constraint sets.
% This not only allows us to keep a check on the complexity of the MPC optimization, but also allows us to formulate the MPC with a quadratic cost on the input to the feedback linearized system \textbf{[InputPaperRef8]}.

%
%\textbf{Note:} So far we have not found an expression for the bound on $\tilde{e}_k$ given $e_k \in E$. While for the rest of this section we assume we have a polyhedral bound $\tilde{e}_k \in \tilde{E}_k \, \forall k$, we will show how to explicitly compute this bounding set $\tilde{E}_k$ using online reachability in Sec.?? . Since we compute $\tilde{E}_{k+j},\, j\geq 0$ using an online reachability method that depends on the state estimate at time $k$, we represent the set as $\tilde{E}_{k+j|k}$ to explicitly show its dependence on the state estimate at time $k$. Similarly, the computed bound for $\What_{k+1}$, given state estimate at time $k$, is given by $\What_{k+1|k}=W\oplus{E}_{k+1|k}\oplus(-A\tilde{E_{k|k}})$. 


\todo[inline]{mention that if shrunk terminal set is non-empty, then nothing in between is empty. }
The RMPC optimization  $\mathbb{P}_{k_0}(\hat{z}_{k_0})$ for solving \eqref{eq:discrete linear problem} is:
%\begin{eqnarray} 
%	\label{eq:nom mpc}
%	J^{*}(\nz_{k}) &=& \min_{\mathbf{\nz},\mathbf{u}} \sum_{j=0}^{N}\lbrace \nz_{k+j|k}^{T}Q \nz_{k+j|k} + {v}_{k+j|k}^{T}R{v}_{k+j|k}\rbrace \nonumber \\ 
%	&\quad & +  \nz_{k+N+1|k}^T Q_f \nz_{k+N+1|k}  \label{eq:cost} \\
%	\nz_{k|k}       &= &\hat{z}_{k} \label{eq:init_cond}\\
%	\nz_{k+j+1|k} &=&A\nz_{k+j|k} + Bv_{k+j|k} , j=0,\ldots,N\label{eq:nom_dyn} \\
%	\nz_{k+j|k}     & \in& \nomZset{k+j}{k} , \; j=0,\ldots,N \label{eq:states_con}\\
%	v_{k+j|k}        & \in & V_{k+j|k} , \;j=0,\ldots,N-1 \label{eq:input_con} \\
%	p_N               &= &\lbrack z_{k+N+1|k} , v_{k+N|k} \rbrack^{T}  \in P_f \label{eq:joint_term} 
%\end{eqnarray}
\begin{subequations} 
\label{eq:nom mpc}
\begin{align}
J^{*}(\nz_{k}) &= \min_{\mathbf{\nz},\mathbf{u}} \sum_{j=0}^{N}\lbrace \nz_{k+j|k}^{T}Q \nz_{k+j|k} + {v}_{k+j|k}^{T}R{v}_{k+j|k}\rbrace \nonumber \\ 
                    &\quad  +  \nz_{k+N+1|k}^T Q_f \nz_{k+N+1|k}  \label{eq:cost} \\
\nz_{k|k}       &= \hat{z}_{k} \label{eq:init_cond}\\
\nz_{k+j+1|k} &=A\nz_{k+j|k} + Bv_{k+j|k} , j=0,\ldots,N\label{eq:nom_dyn} \\
\nz_{k+j|k}     & \in \nomZset{k+j}{k} , \; j=0,\ldots,N \label{eq:states_con}\\
v_{k+j|k}        & \in  V_{k+j|k} , \;j=0,\ldots,N-1 \label{eq:input_con} \\
p_{N+1}               &= \lbrack z_{k+N+1|k} , v_{k+N|k} \rbrack^{T}  \in P_f \label{eq:joint_term} 
	\end{align}
\end{subequations}

Here, $\nz$ is the state of the nominal linearized system
The cost and constraints of the optimization are explained below:
\begin{itemize}
\item Eq. \eqref{eq:cost} shows a cost quadratic in $\nz$ and $v$, where as usual $Q$ is positive definite and R is positive semi-definite. 
In the terminal cost term, $Q_f$ is the solution of the Lyapunov equation $Q_f-(A+BK)^{T}Q_f(A+BK) = Q+K^{T}RK$.
This choice guarantees that the terminal cost equals the infinite horizon cost under a linear feedback control $\nz \mapsto K\nz$ \cite{CannonK15MPC}.

\item Eq. \eqref{eq:nom_dyn} gives the nominal dynamics of the discretized linearized system.

\item Eq. \eqref{eq:init_cond} initializes the nominal state with the current state estimate.

\item Eq. \eqref{eq:states_con} tightens the admissible set of the nominal state by a sequence of shrinking sets.

\item Eq. \eqref{eq:input_con} constrains $v_{k+j|k}$ such that the corresponding $u(x,v)$ is admissible, and the MPC is recursively feasible.

\item Eq. \eqref{eq:joint_term} constrains the final input and nominal state to be within a terminal set $P_f$.

\end{itemize}

\input{constraints}

\input{feasibility}

\input{stability}